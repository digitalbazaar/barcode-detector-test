<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Barcode Detector</title>
    <style>
      body {
        background: #222;
        color: #fff;
      }
      #video {
        border: 1px solid green;
      }
      #clone {
        border: 1px solid blue;
      }
      canvas {
        border: 1px solid red;
        xx-display: none;
      }
    </style>
  </head>
  <body>
    <div>
      <div>
        <h1>v2.5</h1>
      </div>
      <div style="padding-bottom:15px">
        <select
          style="height: 30px; width: 280px"
          id="select"
          onchange="startCamera()">
          <option selected value="user">Front</option>
          <option value="environment">Back</option>
        </select>
        <button
          type="button"
          onclick="reset()"
          style="height: 30px; width: 100px">
          Reset
        </button>
      </div>
      <video autoplay id="video" width="800" height="600"></video>

      <canvas hidden id="canvas" width="800" height="600"></canvas>
      <div>
        <div id="error"></div>
        <div>
          <pre id="decodedText"></pre>
        </div>
        <img hidden id="image" src="https://previews.123rf.com/images/fordzolo/fordzolo1506/fordzolo150600296/41026708-example-white-stamp-text-on-red-backgroud.jpg" width="800" height="600"/>
      </div>
    </div>
    <script>
      const barcodeDetector = new BarcodeDetector();
      const canvas = document.getElementById('canvas');
      const video = document.getElementById('video');
      const select = document.getElementById('select');
      let currentStream;

      startCamera();

      function render() {
        const canvas_context = canvas.getContext('2d');
        let source;
        let binarizer;
        let bitmap;

        canvas_context.fillStyle="#ff0000";
        canvas_context.fillRect(0,0, canvas.width, canvas.height);
        canvas_context.drawImage(video, 0, 0, canvas.width, canvas.height);

        barcodeDetector.detect(canvas).then(barcodes => {
          const decodedText = JSON.stringify(barcodes, null, 2);
          document.getElementById("decodedText").innerHTML = decodedText;
          if(barcodes.length > 0) {
            throw new Error('Done');
          }
        }).then(() => {
          requestAnimationFrame(render);
        }).catch(err => {
          if(err === 'Done') {
            return;
          }
          document.getElementById("error").innerHTML = err;
          throw err;
        })
      }

      function reset() {
        document.getElementById("decodedText").innerHTML = '';
        document.getElementById("error").innerHTML = '';
        render();
      }

      function startCamera() {
        reset();
        navigator.mediaDevices.getUserMedia({
          video: {
              width: 800,
          height: 600,
          facingMode: select.value
          }
        })
        .then(function(stream) {
          video.srcObject = stream;
          render();
        })
        .catch(function(error) {
          console.log('Error', error);
        })
      }
    </script>
  </body>
</html>
